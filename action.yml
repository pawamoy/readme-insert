name: 'README Insert'
description: 'Fetches markup from a URL and updates a file, creating a PR if changes are detected'
author: 'pawamoy'

inputs:
  markup-url:
    description: 'URL to fetch the sponsors markup content from'
    required: true

  file-path:
    description: 'Path to the file to update'
    required: false
    default: 'README.md'

  start-marker:
    description: 'Start marker line in the file (content will be inserted after this)'
    required: false
    default: '<!-- start-insert -->'

  end-marker:
    description: 'End marker line in the file (content will be inserted before this)'
    required: false
    default: '<!-- end-insert -->'

  branch-name:
    description: 'Name of the branch to create for the PR'
    required: false
    default: 'update-readme'

  commit-message:
    description: 'Commit message for the changes'
    required: false
    default: 'chore: Update docs'

  pr-title:
    description: 'Title for the pull request'
    required: false
    default: 'chore: Update docs'

  pr-body:
    description: 'Body text for the pull request'
    required: false
    default: 'Docs updated automatically.'

  base-branch:
    description: 'Base branch to target for the PR'
    required: false
    default: 'main'

runs:
  using: 'composite'
  steps:
    - name: Update specified file
      shell: bash
      env:
        MARKUP_URL: ${{ inputs.markup-url }}
        FILE_PATH: ${{ inputs.file-path }}
        START_MARKER: ${{ inputs.start-marker }}
        END_MARKER: ${{ inputs.end-marker }}
      run: python3 ${{ github.action_path }}/scripts/update_readme.py

    - name: Check for changes
      id: check-changes
      shell: bash
      run: |
        if git diff --quiet ${{ inputs.file-path }}; then
          echo "No changes detected in ${{ inputs.file-path }}"
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected in ${{ inputs.file-path }}"
          echo "changed=true" >> $GITHUB_OUTPUT
        fi

    - name: Create PR if changes detected
      if: steps.check-changes.outputs.changed == 'true'
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Create and switch to new branch
        git checkout -b ${{ inputs.branch-name }}

        # Stage and commit changes
        git add ${{ inputs.file-path }}
        git commit -m "${{ inputs.commit-message }}"

        # Push the branch
        git push origin ${{ inputs.branch-name }} --force

        # Create PR using gh CLI
        gh pr create \
          --base ${{ inputs.base-branch }} \
          --head ${{ inputs.branch-name }} \
          --title "${{ inputs.pr-title }}" \
          --body "${{ inputs.pr-body }}" \
          || echo "PR may already exist"

branding:
  icon: 'file-text'
  color: 'blue'
